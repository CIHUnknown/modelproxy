/**!
 * node-hsf - lib/middleware/accesslog.js
 *
 * Copyright(c) 2013 Alibaba Group Holding Limited.
 * Authors:
 *   苏千 <suqian.yf@taobao.com> (http://fengmk2.github.com)
 */

"use strict";

/**
 * Module dependencies.
 */

var utility = require('utility');
var HSF_VERSION = 'HSF/' + require('../../package.json').version;

/**
 * Access log middleware
 *
 * @param {Object} options
 *  - {Object} logger, must support `accessLog(ip, usec, method, url, status, bytes, referer, userAgent)`
 *  - {String} loggerMethod default is 'accessLog',
 *      if you want to log backend time, you need to set 'accessLogExtra'
 * @return {Function(res)}
 */
module.exports = function (options) {
  var logger = options.logger;
  var loggerMethod = options.loggerMethod || 'accessLog';
  return function accessLogMiddleware(res) {
    var args = [];
    var len = arguments.length;
    for (var i = 1; i < len; i++) {
      var a = arguments[i];
      if (Buffer.isBuffer(a)) {
        args.push(utility.encodeURIComponent(a));
        continue;
      }
      var t = typeof a;
      if (t === 'object') {
        try {
          a = JSON.stringify(a);
        } catch (e) {
        }
      }

      args.push(utility.encodeURIComponent(a));
    }
    args = args.join(',');

    res.__sendOld__ = res.send;
    res.send = function (result, extras) {
      if (this.sended) {
        return;
      }

      var size = this.__sendOld__(result);

      var url = '/hsf/' + this.method + '?pkid=' + this.packetId +
        '&nohsf=' + (this.nohsf ? '1' : '0') +
        '&kl=' + (this.shouldKeepAlive ? '1' : '0') +
        '&sid=' + this.server.options._id +
        '&args=' + args;
      var misc = this.now() - this.starttime;
      var status = 200;

      // try to guest result success or error
      if (result && typeof result === 'object') {
        if (result.status) {
          status = result.status;
        } else if (result.error || result.success === false) {
          status = 500;
        }
      }

      var backendTime = 0;
      var hitCache = 0;
      if (extras) {
        backendTime = extras.use || 0; // 访问后端数据源耗时
        hitCache = extras.cache ? 1 : 0; // 是否命中cache
        if (extras.rid) {
          // support request id
          url += '&x-rid=' + extras.rid;
        }
      }
      logger[loggerMethod](this.remoteAddress || '-', misc, 'GET', url,
        status, size, '-', HSF_VERSION, hitCache, backendTime);
      return size;
    };

    res.next();
  };
};
