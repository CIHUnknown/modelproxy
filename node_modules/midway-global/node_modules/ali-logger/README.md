# ali-logger [![status](http://toast.corp.taobao.com/task/state/id/5520)](http://toast.corp.taobao.com/task/view/id/5520)

适用于哈勃等监控系统错误日志的logger模块

## Install

```js
$ npm install tnpm -g
$ tnpm install ali-logger
```

## Usage

### debug(), info(), warn() and error()

默认支持 `debug`, `info`, `warn` 和 `error` 四种类型的日志

`log` 默认是指向到 `info`.

```js
var logger = require('ali-logger');
logger.init({
  logdir: '/tmp/logs',
  // duration: 3600000 * 24,
  // nameformat: '[{{level}}.]YYYY-MM-DD[.log]',
  // stderr: false, // show error stack in stderr or not
  // level: logger.INFO, // 默认输出 INFO 及以上级别的日志
  // stdoutLevel: logger.ERROR, // 输出到标准输出的最低级别, 默认不输出
});

logger.debug('hello world debug');
logger.log('hello world');
logger.info('hello world');
logger.warn('hello warn');

var err = new Error('test error');
err.url = '/foo';
err.data = { foo: 'bar' };
logger.error(err);
logger.warn(err);

// Listen `logerror` event

logger.on('logerror', function (err, msg) {
  console.log(err.message);
  console.log(err.stack);
  console.log(err.url);
  console.log(err.hostname);
  console.log(err.time);
  console.log(err.data);
});
logger.error(new Error('test logerror'));
```

### 开发调试输出到控制台

如果设置了 `stdoutLevel=DEBUG`, 则会开始 DEBUG 及以上级别的日志输出到标准输出.

![1](http://ww4.sinaimg.cn/large/6cfc7910jw1efhe8xlwrgj20l803mwg5.jpg)

### 通过环境变量打开 DEBUG 模式

```bash
# 会默认将 logger level 设置为 DEBUG
$ NODE_ENV=debug node app.js
```

### 自定义日志方法

通过传递 methods 参数，可以新增自定义日志方法，同时可以指定该方法的日志级别

```js
logger.init({
  methods: [{
    name: 'dberror',
    level: logger.ERROR
  }]
})
```

methods 可接受各种形式的参数：

```
methods: 'trace'
methods: {name: 'trace', level: logger.TRACE}
methods: ['trace', 'mysql']
```

#### Level

日志级别分为

```
DEBUG: -1
INFO: 0
WARN: 1
ERROR: 2
TRACE: 3
```

自定义日志默认分级为 TRACE（最高级别）

### accessLog()

```js
logger.init({
  // ... other options ...
  // access log options
  accessLog: true,
});

// access log
logger.accessLog(ip, usec, method, url, status, bytes, referer, userAgent);
// {ip}     {usec} {pid} [{logdate}]                "{method} {url}"         {status} {bytes} "{referer}" "{userAgent}"
// 127.0.0.1 49429 110 [17/Apr/2013:14:21:01 +0800] "GET /foo/bar?start=1984-10-21" 200 17326 "-" "-"

// 只输出error日志
logger.setLevel(logger.ERROR);
// 只输出warn, error日志
logger.setLevel(logger.WARN);
```

### accessLogMiddleware() on connect

```js
logger.init({
  // ... other options ...
  // access log options
  accessLog: true,
});

var app = connect();
app.use(logger.accessLogMiddleware({
  timer: microtime,
  // method: 'accessLogExtra', // if you want to log backend time, use need to set this
}));
app.use(function (req, res) {
  res.setHeader('Content-Length', req.url.length);
  // res.accessLogBackendTime = 0; // backend time
  // res.accessLogHitCache = 0; // hit cache or not
  res.end(req.url);
});
```

### oplog()

* 集团行为日志: http://docs.alibaba-inc.com/pages/viewpage.action?pageId=106826701
* [集团行为日志平台_查询服务DevGuideV0.2.0](http://docs.alibaba-inc.com/pages/viewpage.action?pageId=106367459)
* TT 配置联系 @TT的技术支持

#### 本地记录日志，通过TT进行推送

```js
logger.init({
  // ... other options ...
  // oplog options
  oplogOptions: {
    systemId: 'xxxxxx_xxx-xx-xx-xx-xx',
    systemName: '系统名称',
  },
});

logger.oplog({
  uid: 43624,
  nick: '苏千',
  realname: '袁锋',
  clientId: 'IP: 10.7.68.72, User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.37 Safari/537.36'
}, {
  traceId: 123,
  targetType: '排行榜',
  customerId: 320,
  name: '更新',
  level: 'NORMAL',
  item: '女装',
  itemId: 16,
  content: {name: ['旧女装', '新女装'], level: [1, 2]}, // => name\u0002旧女装\u0002新女装\u0003level\u00021\u00022
  desc: '更新女装类目名称和等级信息'
});
```

#### 直接http发送日志
此方法用于访问量不大的无线上环境的服务，将直接通过http方式将日志推送到oplog线上服务器。
oplog api 服务地址：

```
日常： http://10.20.153.135:5927
线上： http://api.oplog.alibaba-inc.com
```

```js
logger.init({
  // ... other options ...
  // oplog options
  oplogOptions: {
    systemId: 'xxxxxx_xxx-xx-xx-xx-xx',
    systemName: '系统名称',
    url: 'http://10.20.153.135:5927'
  },
});

logger.oplogByHttp({
  uid: 43624,
  nick: '苏千',
  realname: '袁锋',
  clientId: 'IP: 10.7.68.72, User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.37 Safari/537.36'
}, {
  traceId: 123,
  targetType: '排行榜',
  customerId: 320,
  name: '更新',
  level: 'NORMAL',
  item: '女装',
  itemId: 16,
  content: {name: ['旧女装', '新女装'], level: [1, 2]}, // => name\u0002旧女装\u0002新女装\u0003level\u00021\u00022
  desc: '更新女装类目名称和等级信息'
}, callback);
```

## Benchmark

```bash
$ node benchmark/logdate.js

logger.info("ITier200:%s %s %s %s:%s", use, query, rows.length, tablename, use) x 56,805 ops/sec ±4.06% (82 runs sampled)
logger.warn("ITier200:%s %s %s %s:%s", use, query, rows.length, tablename, use) x 55,124 ops/sec ±4.90% (82 runs sampled)
logger.accessLog('172.168.2.100', 1000000, 'OPTIONS', '/foo/bar/food', 302, 888, '-', 'hsf') x 82,084 ops/sec ±6.75% (69 runs sampled)
ignore info level: logger.info("ITier200:%s %s %s %s:%s", use, query, rows.length, tablename, use) x 15,134,057 ops/sec ±0.76% (93 runs sampled)
Fastest is ignore info level: logger.info("ITier200:%s %s %s %s:%s", use, query, rows.length, tablename, use)
```

## Authors

```bash
$ git summary

 project  : logger
 repo age : 9 months
 active   : 13 days
 commits  : 37
 files    : 10
 authors  :
    35  苏千                  94.6%
     2  不四                  5.4%
```
